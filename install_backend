#!/bin/bash

full_install() {
    _partition_drives
    _format_partitions
    _mount_filesystem
    _run_pacstrap
    _run_genfstab
    _set_rootpw
    _install_grub
    _create_user
}

_partition_drives() {
    cat <<EOF | fdisk ${DEVICE}
g
n
1

+512MiB
y
t
1
n
2


w
EOF
}

get_format_drive() {
    if [[ $DEVICE == *"nvme"* ]]; then
        FORMAT_DRIVE="${DEVICE}p"
    else
        FORMAT_DRIVE="${DEVICE}"
    fi
}

_format_partitions() {
    get_format_drive
    mkfs.fat -F 32 "${FORMAT_DRIVE}1"
    if [[ $FILE_SYSTEM == "btrfs" ]]; then
        mkfs.$FILE_SYSTEM -f "${FORMAT_DRIVE}2"
    else
        yes | mkfs.$FILE_SYSTEM "${FORMAT_DRIVE}2"
    fi
}

_mount_filesystem() {
    get_format_drive
    mount "${FORMAT_DRIVE}2" /mnt
    mkdir -p /mnt/boot/efi
    mount "${FORMAT_DRIVE}1" /mnt/boot/efi
}

_run_pacstrap() {
    packages="base base-devel linux linux-firmware linux-headers sof-firmware ${TEXT_EDITOR} grub efibootmgr"
    pacstrap -K /mnt $packages
}

_run_genfstab() {
    genfstab -U /mnt >> /mnt/etc/fstab
}

_set_rootpw() {
    arch-chroot /mnt echo "root:$ROOT_PW_CONFIRM" | chpasswd
}

_install_grub() {
    mkdir /mnt/chroot
    cat <<EOF > /mnt/chroot/grub_install
#!/bin/bash

main() {
    mount /boot/efi
    grub-install --efi-directory=/boot/efi --target=x86_64-efi --bootloader-id=GRUB --removable
    grub-mkconfig -o /boot/grub/grub.cfg
}
main
EOF

    chmod a+x /mnt/chroot/grub_install
    arch-chroot /mnt /chroot/grub_install
}

_create_user() {
    arch-chroot /mnt useradd -m -G wheel,video,audio $USERNAME -s /bin/bash
    arch-chroot /mnt bash -c "echo '$USERNAME:$user_pass' | chpasswd"
    if [[ $SUDOER = true ]]; then
        arch-chroot /mnt sed -i "/^root.*ALL=(ALL:ALL) ALL/a\\${USERNAME} ALL=(ALL:ALL) ALL" /etc/sudoers
    fi
}
